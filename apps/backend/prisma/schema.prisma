generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

/// 매장 타입 (업종)
enum StoreType {
  MEXICAN
  PUB
  JAPANESE
  KOREAN
  CHINESE
  WESTERN
  CAFE
  GENERAL
}

/// 주문 상태
enum OrderStatus {
  PENDING      // 접수 대기
  CONFIRMED    // 접수 완료
  COOKING      // 조리 중
  COMPLETED    // 완료
  CANCELLED    // 취소
}

/// 세션 상태
enum SessionStatus {
  ACTIVE       // 활성 (손님 있음)
  COMPLETED    // 완료 (계산 완료)
  CANCELLED    // 취소
}

/// 테이블 상태
enum TableStatus {
  AVAILABLE  // 사용 가능
  OCCUPIED   // 사용 중
  RESERVED   // 예약됨
}

/// 호출 상태
enum CallStatus {
  PENDING    // 대기 중
  PROCESSING // 처리 중
  COMPLETED  // 완료
}

/// 매장 정보
model Store {
  id              String   @id @default(uuid())
  
  /// URL 경로에 사용될 업종 ID (소문자, 예: "tacomolly", "pub")
  storeType       String
  
  /// URL 경로에 사용될 지점 ID (소문자, 예: "gimpo", "gangnam")
  branchId        String
  
  /// 매장 전체 이름 (예: "타코몰리 김포점")
  name            String
  
  /// 지점명 (예: "김포점", "강남점")
  branchName      String
  
  /// 매장 타입 Enum
  type            StoreType @default(GENERAL)
  
  /// 초대 코드 (사장님 가입 시 매장 연결용)
  inviteCode      String?   @unique

  /// OKPOS 지점 코드 (연동용)
  okposBranchCode String?   @unique
  
  /// 매장 설명
  description     String?
  
  /// 주소
  address         String?
  
  /// 전화번호
  phoneNumber     String?
  
  /// 영업 시간 (JSON: { weekday: "...", weekend: "..." })
  businessHours   Json?
  
  /// 테마 설정 (JSON: { primaryColor: "...", logo: "..." })
  theme           Json?
  
  /// 활성화 여부
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  menuCategories  MenuCategory[]
  menus           Menu[]
  menuTags        MenuTag[]
  orders          Order[]
  tables          Table[]
  tableSessions   TableSession[]
  staffCalls      StaffCall[]
  
  /// 복합 unique key (같은 업종에서 같은 지점명 불가)
  @@unique([storeType, branchId])
  @@index([storeType])
  @@index([branchId])

  /// 소유자 ID (User 테이블과 연결)
  ownerId         String?
  owner           User?    @relation(fields: [ownerId], references: [id])
}

/// 사용자 정보 (Supabase Auth와 연동)
model User {
  /// Supabase Auth의 UUID와 동일해야 함
  id              String   @id

  /// 이메일
  email           String   @unique

  /// 이름
  name            String?

  /// 전화번호
  phoneNumber     String?

  /// 역할 (ADMIN: 전체 관리자, OWNER: 점주, USER: 일반)
  role            UserRole @default(OWNER)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  stores          Store[]
  errorLogs       ErrorLog[]
}

enum UserRole {
  ADMIN
  OWNER
  USER
}

/// 손님 정보 (비회원 포함)
model Guest {
  id              String         @id @default(uuid())

  /// 전화번호 (적립/할인 시 입력, 고유 식별자)
  phoneNumber     String?        @unique

  /// 이름 (선택)
  name            String?

  /// 이메일 (선택)
  email           String?

  /// 생일 (선택 - 마케팅용)
  birthday        DateTime?

  /// 방문 횟수
  visitCount      Int            @default(0)

  /// 누적 결제 금액
  totalSpent      Int            @default(0)

  /// 마지막 방문일
  lastVisitedAt   DateTime?

  /// 메모 (단골 손님 특이사항 등)
  note            String?

  /// 세션 이력
  sessions        TableSession[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([phoneNumber])
  @@index([visitCount])
  @@index([totalSpent])
}

/// 메뉴 카테고리
model MenuCategory {
  id                String   @id @default(uuid())
  storeId           String
  store             Store    @relation(fields: [storeId], references: [id])
  /// OKPOS 카테고리 코드
  okposCategoryCode String?
  /// 카테고리명
  name              String
  /// 표시 순서
  displayOrder      Int      @default(0)

  menus             Menu[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([storeId, okposCategoryCode])
  @@index([storeId])
}

/// 메뉴 정보
model Menu {
  id              String   @id @default(uuid())
  storeId         String
  store           Store    @relation(fields: [storeId], references: [id])
  categoryId      String
  category        MenuCategory @relation(fields: [categoryId], references: [id])

  /// OKPOS 메뉴 코드
  okposMenuCode   String?
  /// 메뉴명
  name            String
  /// 가격
  price           Int
  /// 상세 설명
  description     String?
  /// 이미지 URL
  imageUrl        String?
  /// 표시 순서
  displayOrder    Int      @default(0)
  
  /// 품절 여부 (OKPOS 연동)
  soldOut         Boolean  @default(false)
  /// 숨김 여부 (키오스크 노출 안함)
  isHidden        Boolean  @default(false)
  /// 삭제 여부 (논리적 삭제)
  isActive        Boolean  @default(true)
  /// 마지막 동기화 시간
  lastSyncedAt    DateTime @default(now())

  optionGroups    MenuOptionGroup[]
  tags            MenuTagRelation[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([storeId, okposMenuCode])
  @@index([storeId, categoryId])
  @@index([storeId, isHidden, isActive])
}

/// 메뉴 옵션 그룹 (예: 사이즈 선택, 맵기 조절)
model MenuOptionGroup {
  id           String       @id @default(uuid())
  menuId       String
  menu         Menu         @relation(fields: [menuId], references: [id], onDelete: Cascade)
  /// 그룹명
  name         String
  /// 최소 선택 개수 (0=선택, 1=필수)
  minSelect    Int          @default(0)
  /// 최대 선택 개수
  maxSelect    Int          @default(1)
  /// 표시 순서
  displayOrder Int          @default(0)

  options      MenuOption[]
}

/// 메뉴 옵션 상세 (예: 보통, 곱배기)
model MenuOption {
  id              String          @id @default(uuid())
  optionGroupId   String
  optionGroup     MenuOptionGroup @relation(fields: [optionGroupId], references: [id], onDelete: Cascade)

  /// OKPOS 옵션 코드
  okposOptionCode String?
  /// 옵션명
  name            String
  /// 추가 가격
  price           Int
  /// 표시 순서
  displayOrder    Int             @default(0)
  /// 품절 여부
  isSoldOut       Boolean         @default(false)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

/// 메뉴 태그 (BEST, HOT, NEW 등)
model MenuTag {
  id              String   @id @default(uuid())
  storeId         String
  store           Store    @relation(fields: [storeId], references: [id])
  
  /// 내부 관리용 태그명
  name            String
  /// 고객에게 보여질 태그명
  displayName     String
  /// 아이콘 (이모지 등)
  icon            String?
  /// 태그 텍스트 색상
  color           String   @default("#FF6B35")
  /// 태그 배경 색상
  backgroundColor String   @default("#FFF5F2")
  /// 표시 순서
  displayOrder    Int      @default(0)
  
  menus           MenuTagRelation[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([storeId, name])
  @@index([storeId])
}

/// 메뉴-태그 연결 테이블 (다대다)
model MenuTagRelation {
  id        String   @id @default(uuid())
  menuId    String
  menu      Menu     @relation(fields: [menuId], references: [id], onDelete: Cascade)
  tagId     String
  tag       MenuTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([menuId, tagId])
  @@index([menuId])
  @@index([tagId])
}

/// 테이블 세션 (손님이 앉아서 나갈 때까지의 단위)
model TableSession {
  id            String        @id @default(uuid())
  storeId       String
  store         Store         @relation(fields: [storeId], references: [id])

  /// 테이블 번호
  tableNumber   Int

  /// 손님 정보 (선택 - 적립 고객인 경우)
  guestId       String?
  guest         Guest?        @relation(fields: [guestId], references: [id])

  /// 손님 수 (필수)
  guestCount    Int

  /// 세션 번호 (예: SES-20241231-001)
  sessionNumber String        @unique

  /// 세션 상태
  status        SessionStatus @default(ACTIVE)

  /// 총 주문 금액 (누적)
  totalAmount   Int           @default(0)

  /// 세션 시작 시간
  startedAt     DateTime      @default(now())

  /// 세션 종료 시간 (계산 완료)
  endedAt       DateTime?

  /// 특이사항
  note          String?

  orders        Order[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([storeId, tableNumber, status])
  @@index([storeId, status])
  @@index([guestId])
  @@index([sessionNumber])
}

/// 주문 정보
model Order {
  id            String      @id @default(uuid())
  storeId       String
  store         Store       @relation(fields: [storeId], references: [id])

  /// 세션 ID (어떤 손님의 주문인지)
  sessionId     String
  session       TableSession @relation(fields: [sessionId], references: [id])

  /// 주문 번호 (예: ORD-20241229-001)
  orderNumber   String      @unique
  /// 테이블 번호 (세션에서 가져옴, 중복 저장)
  tableNumber   Int
  /// 주문 상태
  status        OrderStatus @default(PENDING)
  /// 총 금액
  totalAmount   Int
  /// 특이사항/요청사항
  note          String?

  /// Toss Place 주문 ID (SDK 연동)
  tossOrderId   String?

  items         OrderItem[]

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([sessionId])
  @@index([storeId, status])
  @@index([storeId, tableNumber])
  @@index([orderNumber])
}

/// 주문 아이템 (주문에 포함된 메뉴)
model OrderItem {
  id            String   @id @default(uuid())
  orderId       String
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  /// 메뉴 정보 (스냅샷 - 주문 당시 정보 저장)
  menuId        String
  menuName      String   // 주문 당시 메뉴명
  menuPrice     Int      // 주문 당시 가격
  
  /// 수량
  quantity      Int
  /// 아이템 총 금액 (메뉴 가격 + 옵션 가격) * 수량
  totalPrice    Int
  
  selectedOptions OrderItemOption[]
  
  createdAt     DateTime @default(now())
  
  @@index([orderId])
}

/// 주문 아이템 옵션 (선택된 옵션 스냅샷)
model OrderItemOption {
  id              String    @id @default(uuid())
  orderItemId     String
  orderItem       OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  
  /// 옵션 정보 (스냅샷)
  optionGroupName String   // 그룹명 (예: "사이즈 선택")
  optionName      String   // 옵션명 (예: "큰")
  optionPrice     Int      // 추가 가격
  
  createdAt       DateTime @default(now())
  
  @@index([orderItemId])
}

/// 테이블 정보
model Table {
  id          String      @id @default(uuid())
  storeId     String
  store       Store       @relation(fields: [storeId], references: [id])
  
  /// 테이블 번호
  tableNumber Int
  /// 수용 인원
  capacity    Int         @default(4)
  /// 테이블 상태
  status      TableStatus @default(AVAILABLE)
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  @@unique([storeId, tableNumber])
  @@index([storeId])
}

/// 직원 호출
model StaffCall {
  id          String     @id @default(uuid())
  storeId     String
  store       Store      @relation(fields: [storeId], references: [id])

  /// 테이블 번호
  tableNumber Int
  /// 호출 유형 (물, 수저, 계산 등)
  callType    String?
  /// 호출 상태
  status      CallStatus @default(PENDING)
  /// 처리 완료 시간
  completedAt DateTime?

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([storeId, status])
  @@index([storeId, tableNumber])
}

/// 에러 심각도
enum ErrorSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

/// 에러 소스 (Frontend/Backend)
enum ErrorSource {
  FRONTEND
  BACKEND
}

/// 에러 로그 (Frontend + Backend 통합)
model ErrorLog {
  id          String        @id @default(uuid())

  /// 에러 코드 (예: NETWORK_ERROR, AUTH_FAILED)
  errorCode   String
  /// 에러 메시지
  message     String
  /// 심각도
  severity    ErrorSeverity
  /// 에러 발생 소스
  source      ErrorSource

  /// 스택 트레이스 (있으면)
  stackTrace  String?       @db.Text
  /// 발생 URL (Frontend만)
  url         String?
  /// User Agent (Frontend만)
  userAgent   String?

  /// 사용자 정보 (로그인 상태일 때)
  userId      String?
  user        User?         @relation(fields: [userId], references: [id])

  /// 매장 정보 (컨텍스트)
  storeId     String?

  /// 테이블 번호 (컨텍스트)
  tableNumber Int?

  /// 추가 메타데이터 (JSON)
  metadata    Json?

  createdAt   DateTime      @default(now())

  @@index([createdAt])
  @@index([severity])
  @@index([source])
  @@index([errorCode])
  @@index([storeId])
}
